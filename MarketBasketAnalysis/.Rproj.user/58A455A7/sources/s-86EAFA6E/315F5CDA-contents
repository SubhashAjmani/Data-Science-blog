---
title: "Extended Market basket analysis with enriched outcome visualization"
categories:
  - Machine Learning
  - Market basket analysis
  - Association Learning
  - Unsupervised Learning
description: |
  An ingenious extension to a popular data mining technique to uncover hidden patterns in consumer behavior in medical device industry. It might be useful and/or extended in those industries, where two or more products are not purchased jointly.

preview: HEB.png

author:
  - name: Subhash Ajmani
    url: https://www.linkedin.com/in/subhash-ajmani-467937b/
  - name: Shivesh Jha
    url: https://www.linkedin.com/in/shivesh-jha-56950835/
      
date: 07-23-2019
output:
  distill::distill_article:
    css: style.css
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```


## Abstract

*This article describes an ingenious extension to a popular data mining technique, and demonstrates its success to uncover hidden patterns in consumer behavior in medical device industry. A data mining technique known as market basket analysis (MBA, introduced in 1990s) is applied to investigate various medical devices consumption behaviors by hospitals. This technique is also knowns as association mining or affinity analysis, as it attempts to extract association rules by determining which sets of products or items tend to be purchased jointly. Preliminary examination of input data revealed a critical challenge due to absence of proper transaction definition (a prerequisite to perform MBA), as hospitals do not always buy more than one device together. This prompted exploration of routes to circumvent challenge. The ingenious MBA extension on the reorganized data resulted in meaningful business outcomes. Therefore, indicate that a significant better business decision might be made, by discovering and visualizing hidden patterns in readily available transactional in various industries. In addition, knowledge discovered herein, might be useful and/or extended in those industries, where two or more products are not purchased jointly. In fact, extended MBA results might be helpful in several business scenarios. These include market segmentation, designing catalogues for up-selling or cross-selling, designing promotion and advertising strategies.*



## Introduction

With the exponential growth of data in recent time, we frequently heard the story about how it is radically transforming the face of our world. It might be part of a study for helping to cure a disease, increasing company's revenue, making promotional campaigns more efficient and reading electorate's views more efficiently during election campaign.

> "It is a capital mistake to theorize before one has data.".... [Sherlock Holmes, "A Scandal in Bohemia" Arthur Conan Doyle]

There could be many situations, wherein huge data is available for analysis. However, data may not be useful (as is) due to: 

+ Not being provided in a proper format, as needed for analysis **OR** 
+ Various business-related limitations like data capture/retrieval frequency or other allied restrictions. 

In such cases (with given data limitations/restrictions), data exploration with diverse perspectives needs to be evaluated. This preliminary crucial stage may result in deciding an analytical strategy to obtain meaningful business outcomes. 


> "In the long history of humankind (and animal kind, too) those who learned to collaborate and improvise most effectively have prevailed.".... [Charles Darwin] 

Recently, a similar situation was faced by us where a leading medical device company sought our assistance in discovering influence of various products/categories on each other. This business requirement seems ordinary but is not! Since the nature of the data provided (as is) cannot serve as a direct input to traditional market basket analysis (a conventional technique used to explain this kind of problem). With a substantial amount of debate and theorizing, a solution was designed, to derive product-product influence networks by ingeniously extending Market Basket Analysis. 


## Problem worth to Discovery 

Herein, study objective was to discover product purchase patterns and recommend product bundles possessing significant influence on each other. This is a typical problem in any retail business industry and mostly solved by market basket analysis technique. Traditional MBA is built on items being purchased in same transaction id or more precisely at the same time.

However, while performing preliminary data examination, it was observed, that data provided has more than 95% transactions with the unique item per transaction per invoice. This is primarily due to fact, as most of the time, orders are placed by different doctors/surgical departments as per their own requirements. In addition, it can be the result of purchasing from various sources like Group purchasing organization (GPO), other trade organizations, sales representative of healthcare companies. 

Thus, nature of inappropriate data provided, restricted direct utility of traditional MBA for the present study objective. 

## Potential solution  
  
The problem was approached with an open mind. With no baggage of traditional market basket analysis, we observed data provided, performed exploratory data analysis, drew inferences and developed a strategy. The strategy decided was to reformulate definition of problem statement, which might be helpful to achieve some breakthrough. 
 
Below stages were followed to solve this business problem: 

 1. Frequency analysis to confirm the business hypothesis. 
 2. Restructure problem statement.
 3. Shortlist target products to study. 
 4. Evaluate various machine learning algorithms to solve the problem statement.
 5. Discover Product Baskets and represent these competently. 
 6. Identify targets to increase cross-selling opportunities. 

Each of the above-mentioned stages is discussed in following sections. 
 
 
### 1. Frequency analysis to confirm the business hypothesis

At first, data were reviewed at transaction id level to obtain an understanding of distribution of number of items in each transaction. This helped to validate below hypothesis” 
 
$H_{0}$ : Not more than one item getting transacted in one transaction-id 
$H_{1}$ : Otherwise

To validate the hypothesis, frequency analysis was performed on transaction-id level data. After reviewing the created frequency table, it was concluded that hypothesis for having one item in one transaction was justifiable. Thus, validated hypothesis suggested, traditional market basket analysis may not be directly useful to discover product purchase patterns or product-product influence networks. Extensive literature search was carried out to find any existing solution around this problem. This resulted in scanty literature reports around this problem viz. [1], [2] and [3].

### 2. Restructure problem statement

As it is not a conventional problem, it was further discussed and reviewed. This helped to further understand reasons for biased nature of data, typically single transaction. This was typically due to fact, that most of the time different people/doctors/physicians/procuring agents might be ordering medical devices as per own requirements. Therefore, below problem reformulation was considered for further analysis:

 1. This problem targeted as diverse product consumption pattern of institutions (hospitals mostly) instead of product purchase pattern for individuals.

 2. Observed for stable and reliable measurement unit for deciding product consumption pattern, instead of transaction-id level.
 
Criteria for **stability** was decided such that particular measurement should not fluctuate too much so that it can be generalized well, while criteria for **reliability** was set as particular measurement unit with good product mix.

One may argue that purchase will not directly result into consumption always. However, our data do not have any bulk purchaser for ex: GPO’s (Group Purchasing Organization), it can be safely assumed with some margin of error that quantities purchased by each institution/hospital are for their consumptions.

Below possible measurement units were calculated:

 + Transaction in a "Day" by each institution
 + Transaction in a "Week" by each institution
 + Transaction in a "Month" by each institution
 
It was decided not to proceed with **Month**, as it might dilute product purchase behavior and may not result in actionable insights to take any instant decision. Hence, **Day** and **Week** were tested based on frequency analysis.

```{r , echo=FALSE, fig.cap="Frequency analysis", strip.white = TRUE, message=FALSE, warning=FALSE, fig.width=7, fig.height=4}

library(data.table)
library(ggplot2)
library(RColorBrewer)
library(ggthemes)
library(scales)

# Transaction ID
df1 = data.frame("Transaction_Frequency" = c("Transactions with 1 item", "Transactions with more than 1 item"),"Transaction_ID" = c(97, 3))

# Date
df2 = data.frame("Transaction_Frequency" = c("Transactions with 1 item", "Transactions with more than 1 item"),"Date" = c(4, 96))

# Week
df3 = data.frame("Transaction_Frequency" = c("Transactions with 1 item", "Transactions with more than 1 item"),"Week" = c(0.6, 99.4))

df1 = merge(df1, df2, by = "Transaction_Frequency", all.x = TRUE)
df1 = merge(df1, df3, by = "Transaction_Frequency", all.x = TRUE)

df.m = melt(df1, id.vars = "Transaction_Frequency")
setnames(df.m, "Transaction_Frequency", "TransactionFrequency")
setnames(df.m, "variable", "Variable")
setnames(df.m, "value", "Value")

c.values = c(97.0, 3.0, 96.0, 4.0, 99.4, 0.6)

# Stacked Percent
p1 <- ggplot() + geom_bar(aes(y = Value, x = Variable, fill = TransactionFrequency), data  = df.m, stat="identity", width = 0.5)

p1 <- p1 +geom_text(data=df.m, aes(x = Variable, y = Value, label = paste0(c.values,"%")),colour= "black", family="Atlas Grotesk Medium", size=3)

p1 <- p1 + labs(x="Transaction type", y="Percentage of Transactions") +
 scale_y_continuous(labels = dollar_format(suffix = "%", prefix = "")) +
 theme_bw()+
   scale_fill_fivethirtyeight()

p1

```
 
It was observed that transaction in a **Week** might be a suitable replacement, as it was less noisy as compared to **Day**. In addition, it will not be too late to take any business decisions, as in case of **Month**. This new definition might be helpful for uncovering product basket for medical devices, which might provide insight on consumption pattern for hospitals.

Here, it should be noted that selection of definition of transaction is industry and data-driven and should be selected pragmatically.

Trade pattern in Medical Device also substantiates the proposed reformulation of the problem. Since medical devices are unperishable items and may be consumed over a period of time, if one **Week** or **Month** was considered as transaction, it would help to understand which product may be purchased together in certain time intervals. With this information, business organizations can devise their advertising campaign or design contracts/offers that may increase opportunity for cross-selling.

> "We can not solve our problems with the same level of thinking that created them."....[Albert Einstein]

### 3. Shortlist target products to study

This was an optional stage followed in the present study. In order to maximize impact of resulting product baskets/recommendation, few targeted products (out of huge lot of products) were shortlisted. Pareto’s 80-20 rule was successful to reduce number of products to 6% of overall products. This reduced list of products was analyzed in next stages. Advantages of using this stage on this study were:

 + It reduced noise to greater extent.
 + Return on Investment (ROI) might be higher with above selected targeted products.

### 4. Evaluate various machine learning algorithms to solve problem statement

Various machine learning/deep learning algorithms were evaluated for discovering product baskets/correlations/recommendations.

**Association rule based algorithms:**

 1.	Apriori Algorithm [4]
 2.	Eclat algorithm Zaki [5]
 3.	FP-growth algorithm [6]

**Recommendation system based algorithms:**

 1.	K-nearest Neighbor with cosine similarity [7][8]
 2.	Matrix factorization with singular value decomposition [7][8]
 3.	Neural network based approach [7][9][10]

Apriori algorithm was finalized for this study [4], as it offers below benefits:

 + Easy to interpret
 + Scalable and easy to implement

### 5. Discover Product Baskets and represent these competently

Decided Apriori algorithm was simulated with different level of support, confidence and lift to identify optimal parameters using `arules` package [11][12][13] in **R**. With final set of parameters, product baskets were created. Additionally, a ranking matrix was devised to prioritize these baskets using mix of statistical and business parameters.

After shortlisting important product baskets, it becomes critically important to effectively represent relationship between different products in respective and across baskets.  

Traditional graphical options provided in `arulesviz` [14] package of **R** were able to explain relationship between products with associated rules but not between entire set of products. It was also too theoretical and NOT business-user-friendly. Therefore, various illustrative options were searched in the literature, and some of these are:

 + Network diagram [15]
 + Sankey diagrams [16]
 + Chord diagrams [17]
 + Hierarchical edge bundling [18]

After considering various options, **Hierarchical edge bundling** was finalized to represent study results, as this method offers to effectively illustrate relationship between different set of products irrespective of its rules membership.

Although there were various customized and jazzy options available in **R** and **D3**, the below depiction was adopted using **R** packages `igraph` [19] and `edgebundleR` [20] for its ease of interpretation and simplicity to implement. This depiction provides bi-level outcome illustration:

 + Intricacies of overall influence of products on each other
 + Each product influence on a group of products

```{r , echo=FALSE, fig.cap="A sample representation to illustrate relationship between different set of products", strip.white = TRUE, message=FALSE, warning=FALSE}

pairs <- read.table("HEB_Input.txt",stringsAsFactors = FALSE)

nodes <- t(cbind(t(pairs[,2]), t(pairs[,3])))
library(dplyr)
nodes <- data.frame(nodes) %>% group_by(nodes) %>%
 summarise(count=n())

#node_2 <- nodes
#node_2$Platform <- substr(node_2$nodes,1,regexpr('_', node_2$nodes)-1)


library(edgebundleR)
library(igraph)
library(ggplot2)
# Create the graph object
g <- graph.data.frame(pairs[,2:3], directed=F, vertices=nodes)
# clr <- as.factor(V(g)$Loc)
# levels(clr) <- c("salmon", "wheat", "lightskyblue")
# V(g)$color <- as.character(clr)
# V(g)$size = degree(g)*5
edgebundle(g,tension = 1,width = 550,padding = 70)

```

### 6. Identify targets to increase cross-selling opportunities

In the subsequent stage, selected product baskets were traced back to hospitals list. This enabled accurate identification of hospitals with potential opportunities for cross-selling the products. These hospitals/institutions were recommended as potential target for cross-selling, business expansion and promotion activities.

Once cross-selling opportunities were identified, another problem was faced for estimating potential revenue increases. An extensive literature research was conducted on existing approaches to estimate potential MBA impact. It could not result in relevant reports except [21]. Considering [21] paper guidelines, potential increase in revenue was guesstimated (in view of recommended product baskets).

## Conclusion

This article described a practical approach to extend market basket analysis. Furthermore, convincingly demonstrated its successful application in specific case of single item transaction data to uncover hidden patterns in consumer behavior in medical device industry. The outcomes of the analysis were efficiently utilized to support two business objectives:

 + **Effective monitoring of sales:** Monitor hospitals purchasing particular product baskets.
 + **Cross-selling:** Target those hospitals that are not purchasing items from the product baskets and increase opportunity of cross-selling.

Additionally, it could be valuable in assisting other business requirements such as:

 + **Recommendation Engine:** An industry specific recommendation engine can be built by extending above idea.
 + **Opportunity Analysis:** Map product basket findings along with institutions profile data and can be utilized to conduct Opportunity Analysis.
 + **Customer Churn Analysis:** Product baskets can be used to understand correctly what type of institutions may churn in near future. This is valid only those cases where churn rate is significant.
 + **Inventory Management:** Forecasting can be done precisely for particular product basket and inventory can be managed accordingly.
 + **Promotions:** Promotional campaigns can be strategically designed based on inputs of Product Baskets. Similarly, product baskets inputs can be used to devise strategy for promotional discounts and contract creation. It can additionally be utilized in innovative Catalogue design, brochure design to increase awareness about client portfolio.

 
## References

[1]E. Belyi et al., "Combining association rule mining and network analysis for pharmacosurveillance", The Journal of Supercomputing, vol. 72, no. 5, pp. 2014-2034, 2016. Available: 10.1007/s11227-016-1714-y [Accessed 1 April 2019].

[2]M. Mostafa, "Knowledge discovery of hidden consumer purchase behaviour: a market basket analysis", International Journal of Data Analysis Techniques and Strategies, vol. 7, no. 4, p. 384, 2015. Available: 10.1504/ijdats.2015.073867 [Accessed 1 April 2019].

[3]H. Kim, J. Kim and Q. Chen, "A product network analysis for extending the market basket analysis", Expert Systems with Applications, vol. 39, no. 8, pp. 7403-7410, 2012. Available: 10.1016/j.eswa.2012.01.066 [Accessed 1 April 2019].

[4]R. Agrawal, T. Imieliński and A. Swami, "Mining association rules between sets of items in large databases", ACM SIGMOD Record, vol. 22, no. 2, pp. 207-216, 1993. Available: 10.1145/170036.170072 [Accessed 1 April 2019].

[5]M. Zaki, "Scalable algorithms for association mining", IEEE Transactions on Knowledge and Data Engineering, vol. 12, no. 3, pp. 372-390, 2000. Available: 10.1109/69.846291 [Accessed 1 April 2019].

[6]J. Han, J. Pei and Y. Yin, "Mining frequent patterns without candidate generation", ACM SIGMOD Record, vol. 29, no. 2, pp. 1-12, 2000. Available: 10.1145/335191.335372 [Accessed 1 April 2019].

[7]P. Kordík, "Machine Learning for Recommender systems — Part 1 (algorithms, evaluation and cold start)", Medium, 2018. [Online]. Available: https://medium.com/recombee-blog/machine-learning-for-recommender-systems-part-1-algorithms-evaluation-and-cold-start-6f696683d0ed. [Accessed: 01- Apr- 2019].

[8]S. Li, "How Did We Build Book Recommender Systems in An Hour Part 2 — k Nearest Neighbors and Matrix…", Towards Data Science, 2017. [Online]. Available: https://towardsdatascience.com/how-did-we-build-book-recommender-systems-in-an-hour-part-2-k-nearest-neighbors-and-matrix-c04b3c2ef55c. [Accessed: 01- Apr- 2019].

[9]E. Diaz-Aviles, "A Glimpse into Deep Learning for Recommender Systems", Medium, 2017. [Online]. Available: https://medium.com/libreai/a-glimpse-into-deep-learning-for-recommender-systems-d66ae0681775. [Accessed: 01- Apr- 2019].

[10]A. Artem Oppermann, "Deep Autoencoders For Collaborative Filtering", Towards Data Science, 2018. [Online]. Available: https://towardsdatascience.com/deep-autoencoders-for-collaborative-filtering-6cf8d25bbf1d. [Accessed: 01- Apr- 2019].

[11]M. Hahsler, B. Grün and K. Hornik, "arules- A Computational Environment for Mining Association Rules and Frequent Item Sets", Journal of Statistical Software, vol. 14, no. 15, 2005. Available: 10.18637/jss.v014.i15. [Accessed: 01- Apr- 2019]

[12]M. Hahsler, S. Chelluboina, K. Hornik and C. Buchta, "The arules R-Package Ecosystem: Analyzing Interesting Patterns from Large Transaction Data Sets", Journal of Machine Learning Research. 12 (2011) 2021-2025 Available: http://jmlr.csail.mit.edu/papers/v12/hahsler11a.html.[Accessed: 01- Apr- 2019].

[13]M. Hahsler, C. Buchta, B. Gruen and K. Hornik, "Mining Association Rules and Frequent Itemsets [R package arules version 1.6-3]", Cran.r-project.org, 2019. [Online]. Available: https://CRAN.R-project.org/package=arules. [Accessed: 01- Apr- 2019].

[14]M. Hahsler, T. Giallanza and S. Chelluboina, "Visualizing Association Rules and Frequent Itemsets [R package arulesViz version 1.3-2]", Cran.r-project.org, 2019. [Online]. Available: https://CRAN.R-project.org/package=arulesViz. [Accessed: 01- Apr- 2019].

[15]Y. Healy, "Network diagram", Data-to-viz.com, 2019. [Online]. Available: https://www.data-to-viz.com/graph/network.html. [Accessed: 01- Apr- 2019].

[16]Y. Healy, "Sankey diagram", Data-to-viz.com, 2019. [Online]. Available: https://www.data-to-viz.com/graph/sankey.html. [Accessed: 01- Apr- 2019].

[17]Y. Healy, "Chord diagram", Data-to-viz.com, 2019. [Online]. Available: https://www.data-to-viz.com/graph/chord.html. [Accessed: 01- Apr- 2019].

[18]Y. Healy, "Hierarchical edge bundling", Data-to-viz.com, 2019. [Online]. Available: https://www.data-to-viz.com/graph/edge_bundling.html. [Accessed: 01- Apr- 2019].

[19]G. Csardi and T. Nepusz, "The igraph software package for complex network research", InterJournal, Complex Systems, p. 1695, 2006. [Accessed 1 April 2019].

[20]M. Bostock, E. Patrick, K. Russell and G. Tarr, "edgebundleR: Circle Plot with Bundled Edges [R package edgebundleR version 0.1.4]", Cran.r-project.org, 2016. [Online]. Available: https://cran.r-project.org/web/packages/edgebundleR/index.html. [Accessed: 01- Apr- 2019].

[21]B. Hoanca afbh, "Using Market Basket Analysis to Estimate Potential Revenue Increases for a Small University Bookstore", Semantic Scholar, 2011. [Accessed: 01- Apr- 2019].
